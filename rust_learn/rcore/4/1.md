先来看看有哪些东西变化了

一、完全移除的文件

./os/src/batch.rs

• 变更类型: 移除

• 变更说明: 该文件在第二章中存在，负责应用加载和批处理调度功能

• 变更原因: 功能被拆分为两个更专业的子模块

• 功能拆分去向:

  1. 应用加载功能 → loader.rs
  2. 任务管理功能 → task 子模块

二、新增的文件

新增的配置文件

./os/src/config.rs

• 新增说明: 新增的配置文件

• 作用: 集中保存内核的各种配置参数，如内存布局、栈大小、任务数量等

• 重要性: 提高代码可维护性，将硬编码的配置参数集中管理

新增的加载器模块

./os/src/loader.rs

• 新增说明: 从batch.rs拆分出的应用加载功能

• 主要功能:

  • 将应用程序从存储加载到内存

  • 管理应用程序在内存中的布局

  • 为每个应用创建独立的运行环境

• 与batch.rs的关系: 承接了原batch.rs中的应用加载职责

新增的任务管理模块 (task 子模块)

./os/src/task/ 目录结构


task/
├── context.rs      # 引入Task上下文TaskContext
├── mod.rs          # 全局任务管理器和提供给其他模块的接口
├── switch.rs       # 将任务切换的汇编代码解释为Rust接口__switch
├── switch.S        # 任务切换的汇编代码
└── task.rs         # 任务控制块TaskControlBlock和任务状态TaskStatus的定义


详细说明:

1. context.rs
   • 定义了TaskContext结构体

   • 保存任务执行时的CPU上下文（寄存器状态）

   • 用于任务切换时保存和恢复执行现场

2. mod.rs
   • 任务模块的入口文件

   • 提供全局任务管理器接口

   • 协调各子模块的功能

3. switch.rs 和 switch.S
   • switch.S: 包含任务切换的汇编代码实现

   • switch.rs: 提供Rust调用接口__switch

   • 共同实现底层任务切换机制

4. task.rs
   • 定义了TaskControlBlock（任务控制块）

   • 定义了TaskStatus（任务状态枚举）

   • 管理任务的元数据和状态信息

新增的定时器模块

./os/src/timer.rs

• 新增说明: 计时器相关功能

• 作用: 处理时钟中断，实现时间片轮转调度

• 关联修改: 与sbi.rs中的set_timer调用配合

新增的用户程序构建工具

./user/build.py

• 新增说明: Python构建脚本

• 作用: 构建用户程序，确保它们占用的物理地址区间不相交

• 重要性: 支持多个应用同时加载到内存的不同位置

三、修改的文件

主程序文件

./os/src/main.rs

• 变更类型: 修改

• 修改内容: 主函数进行了重构

• 修改原因: 适应新的任务管理和调度架构

• 具体变化:

  • 初始化新的任务管理器

  • 整合新的应用加载器

  • 设置时钟中断处理

SBI接口文件

./os/src/sbi.rs

• 变更类型: 修改

• 关键修改: 引入新的sbi call set_timer

• 作用: 设置定时器中断，支持分时多任务调度

• 关联性: 与timer.rs配合实现时间片轮转

系统调用模块

./os/src/syscall/

• 变更类型: 修改

• 修改内容: 新增若干系统调用

• 可能新增的系统调用:

  • 与任务调度相关的系统调用

  • 时间相关的系统调用

  • 进程间通信相关的系统调用

陷阱处理模块

./os/src/trap/mod.rs

• 变更类型: 修改

• 修改重点: 时钟中断相应处理

• 修改内容:

  • 增加时钟中断处理逻辑

  • 实现任务调度器的触发机制

  • 处理任务时间片用完的情况

用户程序Makefile

./user/Makefile

• 变更类型: 修改

• 修改内容: 使用build.py构建应用

• 影响: 构建过程现在确保应用地址空间不重叠

用户测试程序

./user/src/bin/

• 变更类型: 修改

• 修改说明: 换成第三章测例

• 新的测试程序:

  • 00power_3.rs: 计算3的幂

  • 01power_5.rs: 计算5的幂

  • 02power_7.rs: 计算7的幂

  • 03sleep.rs: 测试睡眠系统调用

• 测试重点: 验证分时多任务调度和系统调用功能

四、基本未变化的文件

保持稳定的文件

以下文件在Chapter 2和Chapter 3之间基本保持不变，可以跳过详细重讲：

1. ./os/src/console.rs
   • 控制台输出功能，与之前相同

2. ./os/src/entry.asm
   • 内核入口点，启动流程不变

3. ./os/src/lang_items.rs
   • Rust语言项定义，无实质变化

4. ./os/src/link_app.S
   • 应用链接脚本，可能只有细微调整

5. ./os/src/linker-qemu.ld
   • 内核链接脚本，布局基本不变

6. ./os/src/sync/ 目录
   • 同步原语实现，保持稳定

7. ./os/src/trap/context.rs 和 trap.S
   • 陷阱上下文和汇编处理，核心逻辑不变

8. 用户库文件 (./user/src/ 下除bin外的文件)
   • console.rs, lang_items.rs, lib.rs, syscall.rs, linker.ld

   • 提供用户程序运行环境，接口保持稳定

五、重点关注的变化模式

架构演变

从Chapter 2到Chapter 3的核心架构变化：

1. 批处理 → 分时多任务
   • 移除简单的批处理调度

   • 引入完整的任务管理框架

2. 静态加载 → 动态管理
   • 应用加载从静态批处理变为动态任务管理

   • 支持任务切换和调度

3. 无时间片 → 时间片轮转
   • 新增计时器支持

   • 实现基于时间片的调度策略

模块职责重新划分

• batch.rs 的功能被专业模块替代

• 任务管理 成为独立的核心模块

• 应用加载 与 任务调度 解耦

新增的核心机制

1. 任务上下文保存与恢复
2. 任务切换的底层汇编支持
3. 时钟中断驱动的调度器
4. 任务状态管理
5. 应用地址空间隔离